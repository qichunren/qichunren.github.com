<html>
  <head>
    <meta content='使用Jruby来部署Rails应用 - 蕲春人的博客' property='og:title' />
    <title>使用Jruby来部署Rails应用 - 蕲春人的博客</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/syntax.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/responsive.css' rel='stylesheet' type='text/css' />
<!-- - -->
<script src='/javascripts/jquery.js' type='text/javascript'></script>
<script src='/javascripts/pd.js' type='text/javascript'></script>
<script src='/javascripts/basics.js' type='text/javascript'></script>
<!--<script type="text/javascript" src="https://www.google.com/jsapi"></script>-->
<!-- - -->
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />
<meta content="http://muan.co/images/og.png" property="og:image" />
<meta content="" property="fb:app_id" />

  <meta content='/ruby/jruby/rails/deploy/2011/08/26/deploy-rails-project-with-jruby/' property='og:url' />
  <meta content="为了保护最近做的产品的源代码，需要将项目中的源代码进行保护起来。我目前了解到的方案有以下两种：1. 使用代码混淆工具2. 使用JRuby将Ruby代码编译成java字节码文件（.class）-----第一种方案，有一个名为[ruby ..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6344646-4']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>

  </head>
  <body>
    <header>
<p>蕲春人的博客</p>
</header>
    <div id='container'>
      <div class="block">
  
    <a target="_top" class="main" href="/about">About</a>
  
    <a target="_top" class="main" href="http://qichunren.github.io">Blog</a>
  
    <a target="_blank" class="main" href="mailto:whyruby@gmail.com">Email</a>
  
    <a target="_top" class="main" href="https://github.com/qichunren">GitHub</a>
  
</div>
      <section class="paging">
  
    <div class="left">
      <a href="/rails/2011/08/17/proxy-in-server-side-for-ajax-crossing-domain/">
        ‹
      </a>
    </div>
  
  
    <div class="right">
      <a href="/tool/2011/10/12/capture-webpage/">
        ›
      </a>
    </div>
  
</section>
      <div class="content">
        <section class='post'>
          <h1 class="upcase">
            <div class='date'>26 Aug 2011</div>
            使用Jruby来部署Rails应用
          </h1>
          <p>为了保护最近做的产品的源代码，需要将项目中的源代码进行保护起来。我目前了解到的方案有以下两种：</p>

<ol>
<li><p>使用代码混淆工具</p></li>
<li><p>使用JRuby将Ruby代码编译成java字节码文件（.class）</p></li>
</ol>

<hr>

<p>第一种方案，有一个名为<a href="http://rubyencoder.com">ruby encoder</a>的产品，我试用了一下，发现太重量级了，我个人只是一个可以将代码混淆一下的小工具而已，而ruby encoder有自己的运行加载机制，源代码二次编码，基于域名可以设置产品过期失效时间等等一系列功能，我不需要这些功能，另外它不是免费的，所以我没有采用这个方案。</p>

<p>第二种方安装就是使用JRuby。整体思路就是将Ruby项目的代码编译成java字节码文件，然后运行于Java环境中。</p>

<hr>

<p>将项目中的ruby文件编译成java的class文件不是一件容易的事情，所幸有一个名为warbler的gem可以帮助我们搞定这一切，它可以将项目打包(.war)，同时可以将ruby代码编译成class文件。然后你将生成好的.war文件放进JAVA应用服务器的应用目录中，如Tomcat的webapps中就可以了。</p>

<p>warbler提供若干个任务可供使用：
<code>
qichunren@qichunren-desktop:~/code/ntdeck$ warble -T
warble compiled    # Feature: precompile all Ruby files
warble config      # Generate a configuration file to customize your archive
warble executable  # Feature: make an executable archive
warble gemjar      # Feature: package gem repository inside a jar
warble pluginize   # Install Warbler tasks in your Rails application
warble version     # Display version of Warbler
warble war         # Create the project war file
warble war:clean   # Remove the project war file
warble war:debug   # Dump diagnostic information
</code></p>

<p>平时最常用的就是warble war命令了，需要关注的是warble的配置文件，它的配置文件是通过warble config来生成的，在这个文件中有一系列的配置项可以设置，以下是我的配置文件：</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># Disable Rake-environment-task framework detection by uncommenting/setting to false</span>
<span class="c1"># Warbler.framework_detection = false</span>

<span class="c1"># Warbler web application assembly configuration file</span>
<span class="no">Warbler</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># Features: additional options controlling how the jar is built.</span>
  <span class="c1"># Currently the following features are supported:</span>
  <span class="c1"># - gemjar: package the gem repository in a jar file in WEB-INF/lib</span>
  <span class="c1"># - executable: embed a web server and make the war executable</span>
  <span class="c1"># - compiled: compile .rb files to .class files</span>
  <span class="n">config</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="sx">%w(executable compiled)</span>

  <span class="c1"># Application directories to be included in the webapp.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">dirs</span> <span class="o">=</span> <span class="sx">%w(app config db lib log vendor tmp)</span>

  <span class="c1"># Additional files/directories to include, above those in config.dirs</span>
  <span class="c1"># config.includes = FileList[&quot;db&quot;]</span>

  <span class="c1"># Additional files/directories to exclude</span>
  <span class="c1"># config.excludes = FileList[&quot;lib/tasks/*&quot;]</span>

  <span class="c1"># Additional Java .jar files to include.  Note that if .jar files are placed</span>
  <span class="c1"># in lib (and not otherwise excluded) then they need not be mentioned here.</span>
  <span class="c1"># JRuby and JRuby-Rack are pre-loaded in this list.  Be sure to include your</span>
  <span class="c1"># own versions if you directly set the value</span>
  <span class="c1"># config.java_libs += FileList[&quot;lib/java/*.jar&quot;]</span>

  <span class="c1"># Loose Java classes and miscellaneous files to be included.</span>
  <span class="c1"># config.java_classes = FileList[&quot;target/classes/**.*&quot;]</span>

  <span class="c1"># One or more pathmaps defining how the java classes should be copied into</span>
  <span class="c1"># the archive. The example pathmap below accompanies the java_classes</span>
  <span class="c1"># configuration above. See http://rake.rubyforge.org/classes/String.html#M000017</span>
  <span class="c1"># for details of how to specify a pathmap.</span>
  <span class="c1"># config.pathmaps.java_classes &lt;&lt; &quot;%{target/classes/,}p&quot;</span>

  <span class="c1"># Bundler support is built-in. If Warbler finds a Gemfile in the</span>
  <span class="c1"># project directory, it will be used to collect the gems to bundle</span>
  <span class="c1"># in your application. If you wish to explicitly disable this</span>
  <span class="c1"># functionality, uncomment here.</span>
  <span class="c1"># config.bundler = false</span>

  <span class="c1"># An array of Bundler groups to avoid including in the war file.</span>
  <span class="c1"># Defaults to [&quot;development&quot;, &quot;test&quot;].</span>
  <span class="c1"># config.bundle_without = []</span>

  <span class="c1"># Other gems to be included. If you don&#39;t use Bundler or a gemspec</span>
  <span class="c1"># file, you need to tell Warbler which gems your application needs</span>
  <span class="c1"># so that they can be packaged in the archive.</span>
  <span class="c1"># For Rails applications, the Rails gems are included by default</span>
  <span class="c1"># unless the vendor/rails directory is present.</span>
  <span class="c1"># config.gems += [&quot;activerecord-jdbcmysql-adapter&quot;, &quot;jruby-openssl&quot;]</span>
  <span class="c1"># config.gems &lt;&lt; &quot;tzinfo&quot;</span>

  <span class="c1"># Uncomment this if you don&#39;t want to package rails gem.</span>
  <span class="c1"># config.gems -= [&quot;rails&quot;]</span>

  <span class="c1"># The most recent versions of gems are used.</span>
  <span class="c1"># You can specify versions of gems by using a hash assignment:</span>
  <span class="c1"># config.gems[&quot;rails&quot;] = &quot;2.3.10&quot;</span>

  <span class="c1"># You can also use regexps or Gem::Dependency objects for flexibility or</span>
  <span class="c1"># finer-grained control.</span>
  <span class="c1"># config.gems &lt;&lt; /^merb-/</span>
  <span class="c1"># config.gems &lt;&lt; Gem::Dependency.new(&quot;merb-core&quot;, &quot;= 0.9.3&quot;)</span>

  <span class="c1"># Include gem dependencies not mentioned specifically. Default is</span>
  <span class="c1"># true, uncomment to turn off.</span>
  <span class="c1"># config.gem_dependencies = false</span>

  <span class="c1"># Array of regular expressions matching relative paths in gems to be</span>
  <span class="c1"># excluded from the war. Defaults to empty, but you can set it like</span>
  <span class="c1"># below, which excludes test files.</span>
  <span class="c1"># config.gem_excludes = [/^(test|spec)\//]</span>

  <span class="c1"># Pathmaps for controlling how application files are copied into the archive</span>
  <span class="c1"># config.pathmaps.application = [&quot;WEB-INF/%p&quot;]</span>

  <span class="c1"># Name of the archive (without the extension). Defaults to the basename</span>
  <span class="c1"># of the project directory.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">jar_name</span> <span class="o">=</span> <span class="s2">&quot;ntdeck&quot;</span>

  <span class="c1"># Name of the MANIFEST.MF template for the war file. Defaults to a simple</span>
  <span class="c1"># MANIFEST.MF that contains the version of Warbler used to create the war file.</span>
  <span class="c1"># config.manifest_file = &quot;config/MANIFEST.MF&quot;</span>

  <span class="c1"># When using the &#39;compiled&#39; feature and specified, only these Ruby</span>
  <span class="c1"># files will be compiled. Default is to compile all \.rb files in</span>
  <span class="c1"># the application.</span>
  <span class="c1"># config.compiled_ruby_files = FileList[&#39;app/**/*.rb&#39;]</span>
  <span class="n">compile_me</span> <span class="o">=</span> <span class="no">FileList</span><span class="o">[*</span><span class="n">config</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">/**/*.rb&quot;</span><span class="p">}</span><span class="o">].</span><span class="n">exclude</span><span class="p">(</span><span class="s2">&quot;config/compass.rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">&quot;lib/printer/*&quot;</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">compiled_ruby_files</span> <span class="o">=</span> <span class="n">compile_me</span>

  <span class="c1"># === War files only below here ===</span>

  <span class="c1"># Path to the pre-bundled gem directory inside the war file. Default</span>
  <span class="c1"># is &#39;WEB-INF/gems&#39;. Specify path if gems are already bundled</span>
  <span class="c1"># before running Warbler. This also sets &#39;gem.path&#39; inside web.xml.</span>
  <span class="c1"># config.gem_path = &quot;WEB-INF/vendor/bundler_gems&quot;</span>

  <span class="c1"># Files for WEB-INF directory (next to web.xml). This contains</span>
  <span class="c1"># web.xml by default. If there is an .erb-File it will be processed</span>
  <span class="c1"># with webxml-config. You may want to exclude this file via</span>
  <span class="c1"># config.excludes.</span>
  <span class="c1"># config.webinf_files += FileList[&quot;jboss-web.xml&quot;]</span>

  <span class="c1"># Files to be included in the root of the webapp.  Note that files in public</span>
  <span class="c1"># will have the leading &#39;public/&#39; part of the path stripped during staging.</span>
  <span class="c1"># config.public_html = FileList[&quot;public/**/*&quot;, &quot;doc/**/*&quot;]</span>

  <span class="c1"># Pathmaps for controlling how public HTML files are copied into the .war</span>
  <span class="c1"># config.pathmaps.public_html = [&quot;%{public/,}p&quot;]</span>

  <span class="c1"># Value of RAILS_ENV for the webapp -- default as shown below</span>
  <span class="c1"># config.webxml.rails.env = ENV[&#39;RAILS_ENV&#39;] || &#39;production&#39;</span>

  <span class="c1"># Application booter to use, one of :rack, :rails, or :merb (autodetected by default)</span>
  <span class="c1"># config.webxml.booter = :rails</span>

  <span class="c1"># Set JRuby to run in 1.9 mode.</span>
  <span class="c1"># config.webxml.jruby.compat.version = &quot;1.9&quot;</span>

  <span class="c1"># When using the :rack booter, &quot;Rackup&quot; script to use.</span>
  <span class="c1"># - For &#39;rackup.path&#39;, the value points to the location of the rackup</span>
  <span class="c1"># script in the web archive file. You need to make sure this file</span>
  <span class="c1"># gets included in the war, possibly by adding it to config.includes</span>
  <span class="c1"># or config.webinf_files above.</span>
  <span class="c1"># - For &#39;rackup&#39;, the rackup script you provide as an inline string</span>
  <span class="c1">#   is simply embedded in web.xml.</span>
  <span class="c1"># The script is evaluated in a Rack::Builder to load the application.</span>
  <span class="c1"># Examples:</span>
  <span class="c1"># config.webxml.rackup.path = &#39;WEB-INF/hello.ru&#39;</span>
  <span class="c1"># config.webxml.rackup = %{require &#39;./lib/demo&#39;; run Rack::Adapter::Camping.new(Demo)}</span>
  <span class="c1"># config.webxml.rackup = require &#39;cgi&#39; &amp;&amp; CGI::escapeHTML(File.read(&quot;config.ru&quot;))</span>

  <span class="c1"># Control the pool of Rails runtimes. Leaving unspecified means</span>
  <span class="c1"># the pool will grow as needed to service requests. It is recommended</span>
  <span class="c1"># that you fix these values when running a production server!</span>
  <span class="n">config</span><span class="o">.</span><span class="n">webxml</span><span class="o">.</span><span class="n">jruby</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">runtimes</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">config</span><span class="o">.</span><span class="n">webxml</span><span class="o">.</span><span class="n">jruby</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">runtimes</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># JNDI data source name</span>
  <span class="c1"># config.webxml.jndi = &#39;jdbc/rails&#39;</span>
<span class="k">end</span>
</code></pre></div>

<p>需要注意的是config.features = %w(executable compiled)配置中，其中的compiled就是可以将ruby代码编译成class代码的。</p>

          <br />
<p>
  蕲春人
  <span class="muted">at 22:36</span>
</p>
<p>
  <img src="/images/scribble3.png" alt="scribble" />
</p>


        </section>
      </div>
      

      
      <div class="block">
  
    <a target="_top" class="main" href="/about">About</a>
  
    <a target="_top" class="main" href="http://qichunren.github.io">Blog</a>
  
    <a target="_blank" class="main" href="mailto:whyruby@gmail.com">Email</a>
  
    <a target="_top" class="main" href="https://github.com/qichunren">GitHub</a>
  
</div>
    </div>
    <footer>
  <a href="http://github.com/muan/scribble" class="muted">built with Jekyll using Scribble theme</a>
</footer>
  </body>
</html>
